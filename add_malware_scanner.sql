-- Database migration: Add email_attachments table for malware scanning

CREATE TABLE IF NOT EXISTS email_attachments (
    id SERIAL PRIMARY KEY,
    email_id INTEGER REFERENCES emails(id) ON DELETE CASCADE,
    filename VARCHAR(255) NOT NULL,
    file_size INTEGER NOT NULL,
    file_hash VARCHAR(64) NOT NULL,  -- SHA256
    mime_type VARCHAR(100),

    -- ClamAV scan results
    clamav_scanned BOOLEAN DEFAULT FALSE,
    clamav_result VARCHAR(20),  -- 'clean', 'infected', 'error'
    clamav_virus_name VARCHAR(255),
    clamav_scan_time TIMESTAMP,

    -- VirusTotal scan results
    virustotal_scanned BOOLEAN DEFAULT FALSE,
    virustotal_malicious INTEGER DEFAULT 0,  -- Number of engines detected malware
    virustotal_total INTEGER DEFAULT 0,      -- Total engines scanned
    virustotal_permalink VARCHAR(500),
    virustotal_threat_names TEXT,  -- JSON array of threat names
    virustotal_scan_time TIMESTAMP,

    -- Final verdict
    is_malware BOOLEAN DEFAULT FALSE,
    scan_status VARCHAR(50) DEFAULT 'pending',  -- pending, scanning, clean, infected

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_email_attachments_email_id ON email_attachments(email_id);
CREATE INDEX IF NOT EXISTS idx_email_attachments_file_hash ON email_attachments(file_hash);
CREATE INDEX IF NOT EXISTS idx_email_attachments_is_malware ON email_attachments(is_malware);

-- Add column to emails table to track if email has attachments
ALTER TABLE emails ADD COLUMN IF NOT EXISTS has_attachments BOOLEAN DEFAULT FALSE;
ALTER TABLE emails ADD COLUMN IF NOT EXISTS attachments_scanned BOOLEAN DEFAULT FALSE;
ALTER TABLE emails ADD COLUMN IF NOT EXISTS malware_detected BOOLEAN DEFAULT FALSE;
