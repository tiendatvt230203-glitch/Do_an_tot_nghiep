#!/usr/bin/env python3
"""
Malware Scanner Module
Combines ClamAV (local, fast) + VirusTotal (cloud, thorough)
"""

import os
import hashlib
import subprocess
import time
import json
from datetime import datetime

# VirusTotal API
try:
    import vt
    VT_AVAILABLE = True
except ImportError:
    VT_AVAILABLE = False
    print("[WARNING] vt-py not installed. VirusTotal scanning disabled.")

# Configuration
VT_API_KEY = "13c463d6f017371af381c35d2b0829b71832f67d415e35d1e99ecafe9c1d90e1"
VT_THRESHOLD = 3  # If >= 3 engines detect malware ‚Üí BLOCK
VT_MAX_FILE_SIZE = 32 * 1024 * 1024  # 32MB for free tier

# Risky file extensions that need extra scanning
RISKY_EXTENSIONS = {
    '.exe', '.dll', '.scr', '.bat', '.cmd', '.com', '.pif',
    '.js', '.jse', '.vbs', '.vbe', '.wsf', '.wsh',
    '.ps1', '.psm1', '.psd1', '.msi', '.msp', '.hta',
    '.jar', '.app', '.deb', '.rpm', '.apk',
    '.sh', '.bash', '.csh', '.ksh',
    '.py', '.pyc', '.pyo', '.rb', '.pl', '.php'
}

RISKY_MIME_TYPES = {
    'application/x-msdownload',
    'application/x-executable',
    'application/x-dosexec',
    'application/x-javascript',
    'text/javascript',
    'application/javascript',
    'application/x-sh',
    'application/x-shellscript'
}


def calculate_file_hash(file_content):
    """Calculate SHA256 hash of file content"""
    return hashlib.sha256(file_content).hexdigest()


def is_risky_file(filename, mime_type):
    """Check if file type is risky and needs VirusTotal scan"""
    if not filename:
        return False

    ext = os.path.splitext(filename)[1].lower()
    is_risky = ext in RISKY_EXTENSIONS or mime_type in RISKY_MIME_TYPES

    if is_risky:
        print(f"    ‚ö†Ô∏è  Risky file type detected: {filename} ({mime_type})")

    return is_risky


def scan_with_clamav(file_content, filename):
    """
    Scan file with ClamAV
    Returns: {
        'scanned': bool,
        'result': 'clean' | 'infected' | 'error',
        'virus_name': str or None,
        'scan_time': timestamp
    }
    """
    start_time = datetime.now()

    try:
        # Create temp file
        file_hash = calculate_file_hash(file_content)
        temp_path = f"/tmp/scan_{file_hash}_{int(time.time())}"

        with open(temp_path, 'wb') as f:
            f.write(file_content)

        # Scan with ClamAV
        result = subprocess.run(
            ['clamscan', '--no-summary', temp_path],
            capture_output=True,
            text=True,
            timeout=30
        )

        # Remove temp file
        try:
            os.remove(temp_path)
        except:
            pass

        scan_time = datetime.now()

        if result.returncode == 0:
            # Clean
            print(f"    ‚úÖ ClamAV: CLEAN")
            return {
                'scanned': True,
                'result': 'clean',
                'virus_name': None,
                'scan_time': scan_time
            }
        elif result.returncode == 1:
            # Infected - parse virus name
            # Output format: /tmp/scan_xxx: Eicar-Test-Signature FOUND
            output = result.stdout.strip()
            if ':' in output:
                virus_name = output.split(':', 1)[1].replace('FOUND', '').strip()
            else:
                virus_name = 'Unknown malware'

            print(f"    ‚ùå ClamAV: INFECTED - {virus_name}")
            return {
                'scanned': True,
                'result': 'infected',
                'virus_name': virus_name,
                'scan_time': scan_time
            }
        else:
            # Error
            print(f"    ‚ö†Ô∏è  ClamAV: ERROR - {result.stderr}")
            return {
                'scanned': True,
                'result': 'error',
                'virus_name': None,
                'scan_time': scan_time
            }

    except subprocess.TimeoutExpired:
        print(f"    ‚ö†Ô∏è  ClamAV: TIMEOUT")
        return {
            'scanned': False,
            'result': 'error',
            'virus_name': 'Scan timeout',
            'scan_time': datetime.now()
        }
    except Exception as e:
        print(f"    ‚ö†Ô∏è  ClamAV: ERROR - {e}")
        return {
            'scanned': False,
            'result': 'error',
            'virus_name': str(e),
            'scan_time': datetime.now()
        }


def scan_with_virustotal(file_content, file_hash, filename):
    """
    Scan file with VirusTotal API
    Returns: {
        'scanned': bool,
        'malicious': int,
        'total': int,
        'permalink': str,
        'threat_names': list,
        'scan_time': timestamp
    }
    """
    if not VT_AVAILABLE:
        print(f"    ‚ö†Ô∏è  VirusTotal: NOT AVAILABLE (vt-py not installed)")
        return {
            'scanned': False,
            'malicious': 0,
            'total': 0,
            'permalink': None,
            'threat_names': [],
            'scan_time': datetime.now()
        }

    if len(file_content) > VT_MAX_FILE_SIZE:
        print(f"    ‚ö†Ô∏è  VirusTotal: File too large ({len(file_content)} bytes > 32MB)")
        return {
            'scanned': False,
            'malicious': 0,
            'total': 0,
            'permalink': None,
            'threat_names': [],
            'scan_time': datetime.now()
        }

    try:
        print(f"    üîç VirusTotal: Scanning...")
        client = vt.Client(VT_API_KEY)

        # Step 1: Check if hash exists (save quota)
        try:
            file_report = client.get_object(f"/files/{file_hash}")
            stats = file_report.last_analysis_stats

            malicious = stats.get('malicious', 0)
            suspicious = stats.get('suspicious', 0)
            total = sum(stats.values())

            permalink = f"https://www.virustotal.com/gui/file/{file_hash}"

            # Get threat names
            threat_names = []
            if hasattr(file_report, 'last_analysis_results'):
                for engine, result in file_report.last_analysis_results.items():
                    if result['category'] in ['malicious', 'suspicious']:
                        threat_name = result.get('result', 'Unknown')
                        threat_names.append(f"{engine}:{threat_name}")

            client.close()

            print(f"    üìä VirusTotal: {malicious}/{total} engines detected malware")
            if malicious > 0:
                print(f"       Threats: {', '.join(threat_names[:3])}{'...' if len(threat_names) > 3 else ''}")

            return {
                'scanned': True,
                'malicious': malicious,
                'total': total,
                'permalink': permalink,
                'threat_names': threat_names,
                'scan_time': datetime.now()
            }

        except vt.error.APIError as e:
            if e.code == 'NotFoundError':
                # Hash not found - upload new file
                print(f"    üì§ VirusTotal: Uploading new file...")

                import io
                with io.BytesIO(file_content) as f:
                    f.name = filename or 'unknown'
                    analysis = client.scan_file(f)

                # Wait for analysis (max 2 minutes)
                print(f"    ‚è≥ VirusTotal: Waiting for analysis...")
                max_wait = 120  # 2 minutes
                waited = 0

                while waited < max_wait:
                    time.sleep(10)
                    waited += 10

                    try:
                        analysis = client.get_object(f"/analyses/{analysis.id}")
                        if analysis.status == 'completed':
                            break
                    except:
                        pass

                if analysis.status != 'completed':
                    print(f"    ‚ö†Ô∏è  VirusTotal: Analysis timeout")
                    client.close()
                    return {
                        'scanned': False,
                        'malicious': 0,
                        'total': 0,
                        'permalink': None,
                        'threat_names': [],
                        'scan_time': datetime.now()
                    }

                # Get results
                stats = analysis.stats
                malicious = stats.get('malicious', 0)
                total = sum(stats.values())
                permalink = f"https://www.virustotal.com/gui/file/{file_hash}"

                threat_names = []
                if hasattr(analysis, 'results'):
                    for engine, result in analysis.results.items():
                        if result['category'] in ['malicious', 'suspicious']:
                            threat_name = result.get('result', 'Unknown')
                            threat_names.append(f"{engine}:{threat_name}")

                client.close()

                print(f"    üìä VirusTotal: {malicious}/{total} engines detected malware")
                if malicious > 0:
                    print(f"       Threats: {', '.join(threat_names[:3])}{'...' if len(threat_names) > 3 else ''}")

                return {
                    'scanned': True,
                    'malicious': malicious,
                    'total': total,
                    'permalink': permalink,
                    'threat_names': threat_names,
                    'scan_time': datetime.now()
                }
            else:
                raise

    except Exception as e:
        print(f"    ‚ö†Ô∏è  VirusTotal: ERROR - {e}")
        try:
            client.close()
        except:
            pass

        return {
            'scanned': False,
            'malicious': 0,
            'total': 0,
            'permalink': None,
            'threat_names': [],
            'scan_time': datetime.now()
        }


def scan_attachment(file_content, filename, mime_type):
    """
    Main function: Scan attachment with ClamAV + VirusTotal

    Returns: {
        'is_malware': bool,
        'file_hash': str,
        'clamav': {...},
        'virustotal': {...},
        'block_reason': str or None
    }
    """
    print(f"  üìé Scanning attachment: {filename} ({len(file_content)} bytes)")

    # Calculate hash
    file_hash = calculate_file_hash(file_content)
    print(f"    Hash: {file_hash[:16]}...")

    result = {
        'is_malware': False,
        'file_hash': file_hash,
        'clamav': None,
        'virustotal': None,
        'block_reason': None
    }

    # Step 1: ClamAV scan (always)
    clamav_result = scan_with_clamav(file_content, filename)
    result['clamav'] = clamav_result

    if clamav_result['result'] == 'infected':
        result['is_malware'] = True
        result['block_reason'] = f"Malware detected by ClamAV: {clamav_result['virus_name']}"
        print(f"  ‚ùå VERDICT: MALWARE (ClamAV)")
        return result

    # Step 2: Check if risky file type
    if is_risky_file(filename, mime_type):
        # Step 3: VirusTotal scan for risky files
        vt_result = scan_with_virustotal(file_content, file_hash, filename)
        result['virustotal'] = vt_result

        if vt_result['scanned'] and vt_result['malicious'] >= VT_THRESHOLD:
            result['is_malware'] = True
            result['block_reason'] = f"Malware detected by {vt_result['malicious']}/{vt_result['total']} antivirus engines"
            print(f"  ‚ùå VERDICT: MALWARE (VirusTotal: {vt_result['malicious']}/{vt_result['total']})")
            return result

    # Clean
    print(f"  ‚úÖ VERDICT: CLEAN")
    return result


if __name__ == '__main__':
    # Test with EICAR test file
    print("Testing malware scanner...")
    print("="*70)

    # EICAR test string (standard test for antivirus)
    eicar = b'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'

    result = scan_attachment(eicar, 'eicar.com', 'application/octet-stream')
    print("\nResult:", json.dumps(result, indent=2, default=str))
