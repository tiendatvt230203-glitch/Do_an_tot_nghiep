#!/bin/bash
#===========================================
# MALWARE SCANNER DEPLOYMENT SCRIPT
# Deploy ClamAV + VirusTotal to Email Gateway
#===========================================

set -e  # Exit on error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "=========================================="
echo "  DEPLOYING MALWARE SCANNER"
echo "=========================================="
echo "Directory: $SCRIPT_DIR"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "ERROR: Must run as root"
    echo "Usage: sudo ./DEPLOY_MALWARE_SCANNER.sh"
    exit 1
fi

#===========================================
# STEP 1: Install ClamAV
#===========================================
echo "[1/6] Installing ClamAV..."

if command -v clamscan &> /dev/null; then
    echo "  ‚úÖ ClamAV already installed"
else
    echo "  üì¶ Installing ClamAV packages..."
    dnf install -y clamav clamd clamav-update
    echo "  ‚úÖ ClamAV installed"
fi

#===========================================
# STEP 2: Update ClamAV Virus Database
#===========================================
echo ""
echo "[2/6] Updating virus database..."

# Stop clamd if running
systemctl stop clamd@scan 2>/dev/null || true

# Update database
echo "  üîÑ Running freshclam (this may take 5-10 minutes)..."
freshclam || {
    echo "  ‚ö†Ô∏è  freshclam failed, trying alternative method..."
    # Sometimes freshclam fails on first run, try again
    sleep 5
    freshclam || echo "  ‚ö†Ô∏è  Database update failed, continuing anyway..."
}

echo "  ‚úÖ Virus database updated"

#===========================================
# STEP 3: Configure and Start ClamAV Daemon
#===========================================
echo ""
echo "[3/6] Configuring ClamAV daemon..."

# Enable and start clamd
systemctl enable clamd@scan
systemctl start clamd@scan

# Wait for daemon to start
sleep 3

if systemctl is-active --quiet clamd@scan; then
    echo "  ‚úÖ ClamAV daemon running"
else
    echo "  ‚ö†Ô∏è  ClamAV daemon not started (will use clamscan command instead)"
fi

#===========================================
# STEP 4: Install Python Libraries
#===========================================
echo ""
echo "[4/6] Installing Python dependencies..."

pip3 install -q vt-py

echo "  ‚úÖ Python libraries installed"
echo "     - vt-py (VirusTotal API client)"

#===========================================
# STEP 5: Database Migration
#===========================================
echo ""
echo "[5/6] Running database migration..."

if [ -f "add_malware_scanner.sql" ]; then
    echo "  üìä Creating email_attachments table..."

    # Run migration
    psql -U postgres -d email_gateway -f add_malware_scanner.sql 2>&1 | grep -v "already exists" || true

    echo "  ‚úÖ Database migration completed"
else
    echo "  ‚ùå ERROR: add_malware_scanner.sql not found!"
    exit 1
fi

#===========================================
# STEP 6: Test Installation
#===========================================
echo ""
echo "[6/6] Testing installation..."

# Test ClamAV
echo "  üß™ Testing ClamAV..."
if command -v clamscan &> /dev/null; then
    echo "X5O!P%@AP[4\\PZX54(P^)7CC)7}\$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!\$H+H*" > /tmp/eicar.txt
    if clamscan /tmp/eicar.txt 2>&1 | grep -q "Eicar-Test-Signature"; then
        echo "  ‚úÖ ClamAV working correctly (EICAR detected)"
    else
        echo "  ‚ö†Ô∏è  ClamAV test failed (EICAR not detected)"
    fi
    rm -f /tmp/eicar.txt
else
    echo "  ‚ùå ClamAV not found"
    exit 1
fi

# Test Python imports
echo "  üß™ Testing Python modules..."
python3 -c "import vt; print('  ‚úÖ vt-py imported successfully')" 2>&1 || {
    echo "  ‚ùå vt-py import failed"
    exit 1
}

python3 -c "from malware_scanner import scan_attachment; print('  ‚úÖ malware_scanner imported successfully')" 2>&1 || {
    echo "  ‚ùå malware_scanner import failed"
    exit 1
}

# Test database
echo "  üß™ Testing database..."
psql -U postgres -d email_gateway -c "SELECT COUNT(*) FROM email_attachments;" > /dev/null 2>&1 && {
    echo "  ‚úÖ email_attachments table exists"
} || {
    echo "  ‚ùå email_attachments table not found"
    exit 1
}

#===========================================
# STEP 7: Restart Services
#===========================================
echo ""
echo "=========================================="
echo "  RESTARTING EMAIL GATEWAY"
echo "=========================================="

if [ -f "stop.sh" ]; then
    echo "  ‚èπ  Stopping services..."
    ./stop.sh
    sleep 2
fi

if [ -f "start.sh" ]; then
    echo "  ‚ñ∂Ô∏è  Starting services..."
    ./start.sh
else
    echo "  ‚ö†Ô∏è  start.sh not found, please start manually"
fi

#===========================================
# DEPLOYMENT COMPLETE
#===========================================
echo ""
echo "=========================================="
echo "  ‚úÖ MALWARE SCANNER DEPLOYED!"
echo "=========================================="
echo ""
echo "Features enabled:"
echo "  ‚úì ClamAV - Local antivirus scanning"
echo "  ‚úì VirusTotal - Cloud-based multi-engine scanning"
echo "  ‚úì Database tracking for all attachments"
echo "  ‚úì API endpoints for malware stats"
echo ""
echo "API Endpoints:"
echo "  GET  /api/emails/{id}/attachments  - View email attachments"
echo "  GET  /api/malware/stats            - Malware statistics"
echo ""
echo "Workflow:"
echo "  1. Email with attachment arrives"
echo "  2. ClamAV scans (fast, local)"
echo "  3. If risky file type ‚Üí VirusTotal scans"
echo "  4. Malware detected ‚Üí Email blocked"
echo "  5. Clean ‚Üí Email delivered"
echo ""
echo "VirusTotal API Key configured:"
echo "  Key: 13c463d6f017371af381c35d2b0829b71832f67d415e35d1e99ecafe9c1d90e1"
echo "  Tier: Free (500 requests/day, 4 req/min)"
echo ""
echo "Logs:"
echo "  SMTP: tail -f $SCRIPT_DIR/smtp.log"
echo "  API:  tail -f $SCRIPT_DIR/api.log"
echo ""
echo "To view malware stats:"
echo "  curl http://localhost:8000/api/malware/stats"
echo ""
echo "=========================================="
echo "  Deployment completed successfully!"
echo "=========================================="
echo ""
